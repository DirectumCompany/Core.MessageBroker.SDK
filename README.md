# Описание комплекта (SDK) для разработки плагина к MessageBroker

## Комплект поставки

В комплект поставки входят файлы для разработки пакета для .NET, представляющего из себя плагин к брокеру сообщений.

`ExampleTransport` - пример плагина, на основе которого можно написать собственную реализацию.

## Термины и определения

**Брокер сообщений** - набор сервисов из комплекта поставки HR Pro, отвечающих за планирование, маршрутизацию и отправку сообщений.
**Провайдер** - внешний сервис, который принимает от брокера сообщений запросы на отправку сообщений и отправляет их на устройства пользователей.
**Плагин** - упакованный в nuget-пакет проект, реализующий адаптацию и отправку сообщений в провайдер, готовый к установке в приложение брокера сообщений.
**Прокси-сервис** - центральная часть плагина, класс `*TransportProxy`, в котором реализуется ключевой метод для отправки сообщения провайдеру.

## Реализация плагина брокера сообщений

При разработке плагина используйте пример плагина из комплекта поставки.

Необходимо придумать корректное и осмысленное название для плагина и при реализации по примеру `ExampleTransport` во всех местах проекта необходимо изменить наименование 'Example' на придуманное имя. В качестве примера можно привести гипотетическую компанию `Contoso`. В этом случае упоминания `ExampleTransport`, `ExampleTransportProxy` и т.д., будут заменены на `ContosoTransport`, `ContosoTransportProxy` и т.д. во всём проекте.

Состав примера плагина:

* **Models** - папка с моделями провайдера;
* **Plugin** - папки с файлами плагинной системы;
* **Configuration** - настройки плагина;
* **ConfigurationValidator** - валидатор настроек плагина;
* **ExampleTransportProxy** - прокси-сервис провайдера.

В качестве `TargetFramework` рекомендуется использовать `.Net Standard 2.1` (не обязательно, но очень желательно). Если используется другой таргет, то лучше собирать nuget-пакет с опцией `self-contained`.

1. Необходимо реализовать прокси-сервис для передачи информации между брокером сообщений и провайдером.
1. При реализации прокси-сервиса понадобятся модели провайдера и настройки плагина.
1. Для проверки корректности настроек плагина, необходимо добавить валидатор, который проверяет как базовые, так и дополнительные настройки, необходимые для конкретного прокси-сервиса.
1. В проект необходимо добавить загрузчик плагина `*TransportPluginBootstrapper` и сервис-фасад плагина `*TransportPlugin`, по аналогии с файлами из папки `Plugin` примера проекта.

Важно корректно настроить файл проекта плагина `*.csproj`, для этого необходимо добавить:

* блок с описанием пакета;
* блок c копированием в пакет документации, символов отладки и dll зависимостей `IncludeInPackage`;
* блок с внешними библиотеками, где необходимо указать зависимость от nuget-пакета `Core.MessageBroker.Transport.*.nupkg`, идущего в комплекте дистрибутива MessageBroker:
  `<PackageReference Include="Core.MessageBroker.Transport" Version="*" />`
* блок с основными настройками:
  * `<TargetFramework>netstandard2.1</TargetFramework>` заменить на используемый `TargetFramework`;
  * `<AssemblyName>ExampleTransport</AssemblyName>` заменить на наименование плагина;
  * `<RootNamespace>ExampleTransport</RootNamespace>` заменить на наименование плагина;
  * `<CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>`;
  * `<GenerateDocumentationFile>true</GenerateDocumentationFile>`;
  * `<GeneratePackageOnBuild>true</GeneratePackageOnBuild>`;
  * `<TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);IncludeInPackage</TargetsForTfmSpecificContentInPackage>`.

### Содержание модели сообщения Message

Модель сообщения `Message` используется для передачи параметров сообщения из _брокера сообщений_ в _плагин_.

* `string` **Id** - идентификатор сообщения;
* `string` **Title** - заголовок сообщения;
* `string` **Content** - содержимое сообщения;
* `MessagePriority` **Priority** - приоритет сообщения:
  * `enum MessagePriority`:
    * `Low = -1` - низкий приоритет;
    * `Normal = 0` - нормальный приоритет;
    * `High = 1` - высокий приоритет.
* `MessageDeliveryMethod` **DeliveryMethod** - метод доставки:
  * `enum MessageDeliveryMethod`:
    * `Push = 0` - push-метод, сообщения отправляются брокером внешним адресатам, например, в провайдеры отправки СМС;
    * `Pull = 1` - pull-метод, сообщения забираются адресатами самостоятельно у брокера сообщений.
* `string` **DeliveryProxy** - посредник доставки. Возможные значения: **Sms**, **Smtp**, **Viber**. Если нужны push-уведомления, то они пока что жёстко привязаны к **Sms** (см. документацию установки сервиса);
* `DateTimeOffset` **BestBefore** - срок действительности сообщения. Если сообщение не удалось отправить за указанное время, оно помечается как сообщение с истёкшим скором действия и не будет отправлено;
* `Dictionary<string, string>` **Properties** - свойства сообщения. Параметр используется в push-уведомлениях. Также поле может использоваться для передачи специфических параметров сообщения;
* `List<string>` **Tags** - тэги сообщения. Параметр пока не используется;
* `MessageIdentity` **Identity** - получатель сообщения:
  * `class MessageIdentity`:
    * `string` **CredentialType** - тип реквизита удостоверения получателя. В стандартной реализации заполняется значениями ClaimTypes `HTTP://SCHEMAS.XMLSOAP.ORG/WS/2005/05/IDENTITY/CLAIMS/MOBILEPHONE` и `HTTP://SCHEMAS.XMLSOAP.ORG/WS/2005/05/IDENTITY/CLAIMS/EMAILADDRESS` из пространства `System.Security.Claims`. В собственной реализации можно использовать другие значения;
    * `string` **CredentialValue** - значение реквизита удостоверения получателя:
      * для реквизитов с типом `HTTP://SCHEMAS.XMLSOAP.ORG/WS/2005/05/IDENTITY/CLAIMS/MOBILEPHONE` выполняется нормализация значения. Так номера телефонов, которые начинаются на '7' или '8' длиной 11 цифр, считаются валидными. В остальных случаях первым символом всегда должен быть '+' и удовлетворять международному формату.
* `List<MessageAction>` **Actions** - действия. Параметр пока не используется:
  * `class MessageAction`:
    * `string` **Name** - наименование действия;
    * `string` **Title** - заголовок действия;
    * `Dictionary<string, string>` **Parameters** - параметры действия:
      * ключом словаря является название параметра действия;
      * значением словаря является значение параметра действия.
* `List<MessageAttachment>` **Attachments** - вложения. Параметр пока не используется:
  * `class MessageAttachment`:
    * `string` **Title** - заголовок вложения;
    * `string` **Url** - ссылка на вложение.
* `string` **OperationId** - идентификатор внешней операции. Параметр используется для наложения ограничений на повторную отправку кодов в рамках одной операции подтверждения некоего действия;
* `List<DeviceInfo>` **DevicesInfo** - информация об устройствах пользователя. Параметр используется для отправки push-уведомлений:
  * `class DeviceInfo`:
    * `string` **DeviceId** - идентификатор устройства;
    * `Dictionary<string, string>` **TokensInfo** - информация о токенах:
      * ключом словаря является название системы отправки push-уведомлений. Возможные значения: **FCM**, **RuStore**;
      * значением словаря являются пользовательские токены устройств.

### Содержание модели результата отправки сообщения TransmitResult

Модель `TransmitResult` используется для передачи результата отправки сообщения из _плагина_ в _брокер сообщений_.

* `bool` **IsSuccess** - `true`, если сообщение было успешно отправлено;
* `Error` **Error** - ошибка, возникшая во время отправки сообщения:
  * `class Error`:
    * `string` **Message** - описание ошибки;
    * `string` **Code** - код ошибки. Для указания значения следует пользоваться перечислением `enum ErrorCode`. Значения перечислены ниже;
    * `string` **StackTrace** - стек-трейс системного исключения;
    * `string[]` **UnregisteredTokens** - список незарегистрированных токенов. Используется при отправке push-уведомлений.

Коды ошибок, при которых попыток отправить конкретное сообщение больше не будет:

* **IncorrectMessageDataError** - некорректные данные в сообщении. Примеры сообщений об ошибке:
  * "Сообщение не содержит информацию о номере телефона";
  * "Не задан ни заголовок, ни содержимое сообщения";
  * "Ошибка в реквизитах сообщения {pluginType} {responseBody}".
* **IncorrectPhoneNumberError** - некорректный номер телефона, применяется при нормализации и валидации. Примеры сообщений об ошибке:
  * "Номер телефона должен быть либо валидным международным номером, либо начинаться с '7', '8' и содержать 11 цифр".
* **InvalidCredentialTypeError** - указан неверный типа реквизита получателя. Примеры сообщений об ошибке:
  * "Тип реквизита получателя '{credentialType}' в сообщении {messageId} является некорректным для плагина {pluginType}".
* **MessageDeliveryError** - ошибке доставки сообщения, без указания конкретики. Примеры сообщений об ошибке:
  * "Не удалось отправить сообщение т.к. пришел неожиданный ответ {pluginType} {responseBody}";
  * "Ошибка во время доставки сообщения {pluginType} {responseBody}".
* **MessageTransmitBlockedError** - ошибка при блокировке номера со стороны провайдера. Примеры сообщений об ошибке:
  * "Ошибка ожидания транспорта {pluginType} {responseText}. Транспорт будет временно заблокирован на {timeout} т.к. было слишком много ошибочных запросов";
  * "Не удалось отправить сообщение {messageId}. Сообщение запрещено (по тексту или по имени отправителя)".
* **TransmitRetryExceededError** - ошибка при слишком большом количестве попыток отправки. Не используется напрямую в плагинах. Работает в паре с настройкой `MaxTransmitRetryCount`. Примеры сообщений об ошибке:
  * "Слишком много попыток отправить сообщение {messageId} посредством канала доставки '{deliveryProxyName}'".
* **TransportAuthorizeError** - ошибках авторизации на стороне провайдера. Примеры сообщений об ошибке:
  * "Ошибка авторизации транспорта {pluginType} {responseBody}".
* **SystemError** - системная или неизвестная ошибка.

Коды ошибок, при которых попытка отправить конкретное сообщение будет через некоторый промежуток времени (через `ProcessDelayMs` мс):

* **MessagePendingError** - временная приостановка отправки корректного сообщения. Примеры сообщений об ошибке:
  * "Ошибка ожидания транспорта {pluginType}. Сообщение {messageId} уже было отправлено ранее, повторная отправка возможно не ранее чем через {timeout}".
* **PriorityLimitError** - достигнут лимит сообщений по приоритету. Примеры сообщений об ошибке:
  * "Ошибка из-за достижения лимита сообщений {messagePriority} приоритета".
* **MessageTransmitError** - неудачная попытка отправки сообщения. Примеры сообщений об ошибке:
  * "Не удалось отправить сообщение {pluginType} {responseBody}".
* **TransportPendingError** - ошибка ожидания ответа от провайдера. Действует сразу на все сообщения, отправляемые через указанный плагин. Примеры сообщений об ошибке:
  * "Ошибка ожидания транспорта";
  * "Ошибка из-за достижения лимита сообщений".

Коды ошибок для push-уведомлений:

* **PushDeliveryError** - ошибка при отправке push-уведомления. Примеры сообщений об ошибке:
  * "Ошибка при отправке Push уведомления. Ответ от сервера {statusCode}" - push-уведомление не отправлено. Сообщение будет отправлено через `Sms`;
  * "Ошибка при отправке Push уведомления. Не удалось отправить Push уведомление" - push-уведомление не отправлено. Сообщение будет отправлено через `Sms`;
  * "Ошибка при отправке Push уведомления. Обнаружены незарегистрированные токены" - переданные токены помечаются как удаленные. Само это сообщение в логах не означает, что push-уведомление не отправлено.

Любые системные исключения следует оборачивать в результат `TransmitResult` с указанием стек-трейса `Error.StackTrace` и кода ошибки `Code = SystemError`, как это реализовано в примере плагина.

### Конфигурация плагина

Конфигурация плагина хранится в секции `Transport:Proxies` настроек планировщика брокера сообщений. Она может содержать любое разумное количество настроек, необходимых для реализации функциональности плагина. Для удобства разработки в класс `ConfigurationBase` выделены наиболее обобщенные параметры:

* **Host** - имя хоста. Пример: `notify.contoso.com`;
* **Port** - номер порта. Пример: `443`;
* **Path** - путь для подключения к провайдеру. Пример: `/v1/messages`;
* **UseSsl** - признак необходимости использования SSL. `true`, если общение с сервисом происходит по защищенному каналу;
* **Username** - имя пользователя для авторизации запросов к провайдеру;
* **Password** - пароль пользователя для авторизации запросов к провайдеру;
* **MessagesPerSecond** - количество сообщений в секунду, которые позволяет обрабатывать сервис. 0, если неограниченно. Брокер сообщений будет соблюдать указанную скорость при массированной отправке сообщений.

В примере `ExampleTransport` используются все указанные настройки плюс дополнительная настройка `Sender`, имя отправителя.

## Подключение плагина к MessageBroker

Для подключения плагина предварительно соберите реализованный проект в nuget-пакет. Далее приведены инструкции для самостоятельной установки в ОС Windows и Linux. Если вы используете установщик `DirectumLauncher`, то обратитесь к соответствующей инструкции из комплекта поставки компонента установки `DLC MessageBroker`.

### Windows

1. В папке с планировщиком заданий `CoreMessageBroker\Scheduler` в конфигурационном файле `appsettings.json` заполните параметры.
1. Собранный в результате сборки, nupkg плагина скопировать в директорию указанную в настройках, по умолчанию это `./Plugins` проекта `CoreMessageBroker.Scheduler`.
1. Укажите название плагина в настройке `*DeliveryProxy`, где вместо `*` нужно указать тип сообщений, отправка которых реализуется в плагине. Пример для `SmsDeliveryProxy`:

```json
  "Transport": {
    ...
    "SmsDeliveryProxy": "ExampleTransportPlugin",
    "ExampleTransportPlugin": {
      "Setting1": "",
      "Setting2": "",
      "Setting3": "",
      ...
    },
    ...
  }
```

### Linux

1. Укажите название плагина в настройке `Transport__*DeliveryProxy`, где `*` нужно указать тип сообщений, отправка которых реализуется в плагине.
1. Добавьте собранный nuget-пакет с плагином в образ:
   * примонтируйте папку, в которой находится плагин;
   * переопределите `entrypoint` для копирования плагинов из `volume` в основную директорию.

Пример для `SmsDeliveryProxy`:

```yml
services:
  message-broker-scheduler:
    image: registry.directum.ru/hrpro/directum.message.scheduler:*.*.*.*
    entrypoint: "sh -c 'cp /Plugins/*nupkg /app/Plugins && dotnet Core.MessageBroker.Scheduler.dll'"
    environment:
      ...
      Transport__SmsDeliveryProxy: "ExampleTransportPlugin"

      Transport__Proxies__ExampleTransportPlugin__Setting1: ""
      Transport__Proxies__ExampleTransportPlugin__Setting2: ""
      Transport__Proxies__ExampleTransportPlugin__Setting3: ""
      ...
    volumes:
      - ./Plugins:/Plugins
    ports:
      - "*:*"
```
